<!DOCTYPE html>
<html>

<head>
  <% include ./partials/head.ejs %>

</head>

<body>
  <% include ./partials/nav.ejs %>

    <div id="lobipanel">

      <p></p>
      <div id="lobipanel-multiple">

        <div class="bs-example">
          <div class="row">
            <div id="lobipanel-parent" class="col-md-4 lobipanel-parent">
              <div class="panel panel-primary" data-stateful="true" data-inner-id="lobipanel-parent-default">
                <div class="panel-heading">
                  <div class="panel-title">
                    <h4>Lamps</h4>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/lamp-gu-off.png" alt="" width="50px" id="lamp-gu-img">
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading">Living Room</h4>

                    </div>
                    <div class="media-right">
                      <input type="checkbox" id="lamp-gu" name="lamp" data-toggle="toggle" data-width="70" data-onstyle="success" data-size="small">
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/lamp-be-off.png" alt="" width="50px" id="lamp-be-img">
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading"> Bed Room</h4>

                    </div>
                    <div class="media-right">
                      <input type="checkbox" id="lamp-be" name="lamp" data-toggle="toggle" data-width="70" data-onstyle="success" data-size="small">
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/lamp-ki-off.png" alt="" width="50px" id="lamp-ki-img">
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading">Kitchen</h4>

                    </div>
                    <div class="media-right">
                      <input type="checkbox" id="lamp-ki" d name="lamp" data-toggle="toggle" data-width="70" data-onstyle="success" data-size="small">
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/lamp-ba-off.png" alt="" width="50px" id="lamp-ba-img">
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading">Bath Room</h4>

                    </div>
                    <div class="media-right">
                      <input type="checkbox" id="lamp-ba" name="lamp" data-toggle="toggle" data-width="70" data-onstyle="success" data-size="small">
                    </div>
                  </div>
                </div>
              </div>
              <div class="panel panel-primary" data-stateful="true" data-inner-id="lobipanel-parent-primary">
                <div class="panel-heading">
                  <div class="panel-title">
                    <h4>Humidity Sensor</h4>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="media">
                    <div class="media-left">
                      <div id="humidity"></div>
                    </div>

                    <div class="media-right">
                      <div id="chart-container">FusionCharts will render here</div>
                    </div>

                  </div>
                </div>
              </div>

            </div>

            <div class="col-md-4">
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <div class="panel-title">
                    <h4>CCTV</h4>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/cctv.png" alt="" width="50px">
                      <div class="media-body">
                        <h4 class="media-heading"></h4>

                      </div>
                  </div>
                  <div class="media-right">
                      <input type="button" id="cctv" name="cctv" onclick="popupcctv()" value=" Show" class="btn btn-primary"></a>
                  </div>
                        <iframe hidden="true" src="http://192.168.123.2:8088" id="cctvView" width="90%" style="height:75vh;"></iframe>

                  </div>
                </div>
              </div>
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <div class="panel-title">
                    <h4>Windows</h4>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/window-off.png" alt="" width="50px" id="win-gu-img">
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading">Bath/Toilet Room</h4>

                    </div>
                    <div class="media-body">
                      <div class="win-gu">

                      </div>
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/window-off.png" alt="" width="50px" id="win-be-img">
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading"> Bed Room</h4>

                    </div>
                    <div class="media-body">
                      <div class="win-be">

                      </div>
                    </div>
                  </div>
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/window-off.png" alt="" width="50px" id="win-ki-img">
                    </div>
                    <div class="media-body">
                      <h4 class="media-heading">Kitchen</h4>

                    </div>
                    <div class="media-body">
                      <div class="win-ki">

                      </div>
                    </div>
                  </div>

                </div>
              </div>
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <div class="panel-title">
                    <h4>Door</h4>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/door-off.png" alt="" width="50px" id="door-oc-img">
                      <div class="media-body">
                        <h4 class="media-heading"></h4>

                      </div>
                    </div>

                    <div class="media-right">
                      <input type="checkbox" id="door-openclose" data-toggle="toggle" data-onstyle="info" data-width="70" data-size="small" data-on="open" data-off="close "></br>
                      <input type="checkbox" id="door-lock" data-toggle="toggle" data-on="unlock" data-off="lock " data-size="small" data-offstyle="success">
                    </div>


                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <div class="panel-title">
                    <h4>Security</h4>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="media">
                    <div class="media-left">
                      <img src="/images/security-off.png" alt="" width="50px" style="display:inline;" id="security-img">

                    </div>
                    <div class="media-body">
                        <span class="security"></span>
                    </div>
                    <div class="media-right">
                      <input type="checkbox" id="security" data-toggle="toggle" data-onstyle="info" data-width="70" data-size="small">
                    </div>

                  </div>
                </div>

              </div>
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <div class="panel-title">
                    <h4>Alert</h4>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="media">
                    <div class="media-left">
                      <div id="gas">

                      </div>
                    </div>

                    <div class="media-right">
                      <div id="flame">

                      </div>
                    </div>

                  </div>
                </div>
              </div>

              </div>
            </div>
          </div>
      <audio id="song">

        <source src="mp3/01.wav" type="audio/mpeg">
      </audio>

</body>
<script>
  $(function() {
    var codes = $('.highlight code');
    codes.each(function(ind, el) {
      hljs.highlightBlock(el);
    });

    $('.lobipanel').lobiPanel();
    $('#demoPanel11').lobiPanel();
    $('#lobipanel-basic').lobiPanel();
    $('#lobipanel-custom-control').lobiPanel({
      reload: false,
      close: false,
      editTitle: false
    });
    $('#lobipanel-stateful').lobiPanel({
      stateful: true
    });
    $('#lobipanel-font-awesome').lobiPanel({
      reload: {
        icon: 'fa fa-refresh'
      },
      editTitle: {
        icon: 'fa fa-edit',
        icon2: 'fa fa-save'
      },
      unpin: {
        icon: 'fa fa-arrows'
      },
      minimize: {
        icon: 'fa fa-chevron-up',
        icon2: 'fa fa-chevron-down'
      },
      close: {
        icon: 'fa fa-times-circle'
      },
      expand: {
        icon: 'fa fa-expand',
        icon2: 'fa fa-compress'
      }
    });
    $('#lobipanel-constrain-size').lobiPanel({
      minWidth: 300,
      minHeight: 300,
      maxWidth: 600,
      maxHeight: 480
    });
    $('#lobipanel-from-url').on('loaded.lobiPanel', function(ev, lobiPanel) {
      var $body = lobiPanel.$el.find('.panel-body');

      hljs.highlightBlock($body.find('code')[0]);
    }).lobiPanel({
      loadUrl: 'bootstrap/dist/css/bootstrap.min.css',
      bodyHeight: 400
    });
    $('#lobipanel-multiple').find('.panel').lobiPanel({
      sortable: true,
      beforeTitleChange: function(lobiPanel, title) {
        if (!title) {
          return false;
        }
      }
    });
  });
  var check = false;
  var evt = null;
  var lampIDs = ['#lamp-gu', '#lamp-be', '#lamp-ki', '#lamp-ba'];
  var winIDs = ['.win-gu', '.win-be', '.win-ki'];
  var win = ['win-gu','win-be','win-ki'];
  var song = document.getElementById('song');
  var socket = io(); //load socket.io-client and connect to the host that serves the page
  window.addEventListener("load", function() { //when page loads
    var sData = {};
    for (var i = 0; i < lampIDs.length; i++) {
      $(lampIDs[i]).change(function() {
        sData.type = 'LAMPS';
        sData.idx = lampIDs.indexOf('#' + this.id);
        sData.value = this.checked;
        document.getElementById(this.id+'-img').src = "/images/"+this.id+"-"+((this.checked)?"on":"off")+".png"

        socket.emit('control', sData);
      });
    }
    // request all data
    socket.emit('control', {type: 'ALL'});

    $('#door-openclose').change(function() {
      if(evt){
        evt = null;
        return;
      }
      sData.type = 'DOOR';
      sData.idx = 0;
      sData.value = this.checked;
      if (!this.checked) {
        document.getElementById('door-oc-img').src = "/images/door-off.png"
      }else {
        document.getElementById('door-oc-img').src = "/images/door-on.png"
      }
      socket.emit('control', sData);
    });
    $('#door-lock').change(function() {
      sData.type = 'DOOR';
      sData.idx = 1;
      sData.value = this.checked;
      if (!this.checked) {
        document.getElementById('door-oc-img').src = "/images/door-lock.png"
      }else {
        document.getElementById('door-oc-img').src = "/images/door-unlock.png"
      }
      socket.emit('control', sData);
    });
    $('#security').change(function() {
      sData.type = 'SECURITY';
      sData.idx = 0;
      sData.value = this.checked;
      if (!this.checked) {
        document.getElementById('security-img').src = "/images/security-off.png"
      }else {
        document.getElementById('security-img').src = "/images/security-on.png"
      }
      socket.emit('control', sData);
      check = this.checked;
    });
    $('#alert').change(function() {
      sData.type = 'security';
      sData.idx = 1;
      sData.value = this.checked;
      socket.emit('control', sData);
    });


    socket.on('control', function(data) { //get button status from client
      switch (data.type) {
        case 'ALL':
          setInit(data.init);
          break;
        case 'LAMPS':
          $(lampIDs[data.idx]).prop('checked', data.value).change();
          break;
        case 'DOOR':
            evt = true;
            $('#door-openclose').bootstrapToggle( (data.value)?'on':'off');
               if(data.value == 1){
                 console.log("door open state");
               }else if (data.value == 0) {
                 console.log("door close state");
               }
          break;
        case 'WINDOW':
        for(var i = 0; i < winIDs.length; i++){

          if (data.value) {
              if(check){
                  song.pause();
              }
              document.getElementById(win[data.idx]+'-img').src = "/images/window-off.png"
            $(winIDs[data.idx]).notify(
              "Window is close", {
                autoHide: false,
                clickToHide: false,
                className: 'success'
              }
            );
          } else {
              document.getElementById(win[data.idx]+'-img').src = "/images/window-on.png"
              if (check) {
                 song.play();
              }
            $(winIDs[data.idx]).notify(
              "Window is open", {
                autoHide: false,
                clickToHide: false,
                className: 'error'
              }
            );
          }
        }
         break;
         case 'DHT':
           if(data.idx == 0){
             FusionCharts.items["myThm"].feedData("&value=" + data.value);
           }else {
             humidity.refresh(data.value);
           }
           break;
         case 'ADC':
            if (data.idx == 0) {
              gas.refresh(data.value);
            }else {
              flame.refresh(data.value);
            }

           break;
        case 'MOTION':
          if (data.idx == 0 && check) {

            if (data.value) {
              $('.security').notify(
                "Your Home Is Not Save", {
                  autoHide: false,
                  clickToHide: false,
                  className: 'error'
                }
              );
              song.play();
            }else {
              $('.security').notify(
                "Your Home Is Save", {
                  autoHide: false,
                  clickToHide: false,
                  className: 'success'
                }
              );
              song.pause();
            }
          }

          break;
          case "ALARM":
                    show(data.idx,data.value);
                    song.play();

              break;

        default:

      }
    });

  });

  FusionCharts.ready(function() {
    var updateAnnotation,
      chart = new FusionCharts({
        type: 'thermometer',
        renderAt: 'chart-container',
        id: 'myThm',
        width: '160',
        height: '210',
        dataFormat: 'json',
        dataSource: {
          "chart": {
            "caption": "Temperature",
            "subcaption": "In Your Home",
            "showhovereffect": "1",
            "thmFillColor": "#008ee4",
            "showGaugeBorder": "1",
            "gaugeBorderColor": "#008ee4",
            "gaugeBorderThickness": "2",
            "gaugeBorderAlpha": "30",
            "thmOriginX": "100",
            "chartBottomMargin": "20",
            "valueFontColor": "#000000",
            "theme": "fint"
          },
          "value": "-6",
          //All annotations are grouped under this element

        },
        "events": {
          "initialized": function(evt, arg) {

            updateAnnotation = function(evtObj, argObj) {
              var code,
                chartObj = evtObj.sender,
                val = chartObj.getData(),
                annotations = chartObj.annotations;

              if (val >= -4.5) {
                code = "#00FF00";
              } else if (val < -4.5 && val > -6) {
                code = "#ff9900";
              } else {
                code = "#ff0000";
              }
              annotations.update("background", {
                "fillColor": code
              });
            };
          },
          "renderComplete": function(evt, arg) {
            updateAnnotation(evt, arg);
          },
          "realtimeUpdateComplete": function(evt, arg) {
            updateAnnotation(evt, arg);
          }
        }
      })
      .render();
  });

  var humidity = new JustGage({
    id: "humidity",
    value: 0,
    min: 0,
    max: 100,
    title: "Humidity temperature",
    label: "Celsius",
    startAnimationTime: 2000,
    startAnimationType: ">",
    refreshAnimationTime: 1000,
    refreshAnimationType: "bounce"
  });

  var flame = new JustGage({
    id: "flame",
    value: 760,
    min: 760,
    max: 1100,
    title: "Flame",
    label: "NM",
    startAnimationTime: 2000,
    startAnimationType: ">",
    refreshAnimationTime: 1000,
    refreshAnimationType: "bounce"
  });

  var gas = new JustGage({
    id: "gas",
    value: 300,
    min: 300,
    max: 1000,
    title: "Gas",
    label: "PPM",
    startAnimationTime: 2000,
    startAnimationType: ">",
    refreshAnimationTime: 1000,
    refreshAnimationType: "bounce"
  });
  var off = true;

  function popupcctv() {
    //var newwindow = window.open('http://192.168.123.2:8088','CCTV','height=500,width=500');
    document.getElementById('cctvView'). hidden = !off;
    if(off){
        document.getElementById('cctv').value = "Hide";
    }else {
        document.getElementById('cctv').value = "Show";
    }
    off = !off;
  }

function setInit(data){
    humidity.refresh(data.humidity);
    flame.refresh(data.flame);
    gas.refresh(data.gas);
    FusionCharts.items["myThm"].feedData("&value=" + data.temperature);
    for (var i = 0; i < 3; i++) {
        $(winIDs[i]).notify(
            "Window is "+((data.windows[i])?"close":"open"), {
            autoHide: false,
            clickToHide: false,
            className: (data.windows[i])?"success":"error"
            }
        );
    }
    for (var i = 0; i < 4; i++) {
        $(lampIDs[i]).prop('checked', data.lamps[i]).change();
    }
}
        function show(type,value) {
            var set = Lobibox.alert("error",{msg: ((type== 0)? "Gas ": "Flame")+ " Alarm!!! Please Check Your Home Your "+((type== 0)?"Gas":"Flame")+ " Level is "+ value});
             set.setWidth(1200);
             set.setPosition(100,300);
        }
</script>

</html>
